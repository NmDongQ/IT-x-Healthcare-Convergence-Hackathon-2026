<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>뚝뚝 - 고객 관리</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app-shell">
      <header class="topbar">
        <div class="topbar-inner">
          <a class="brand" href="index.html">
            <span class="logo-box" aria-hidden="true"></span>
            <span>뚝뚝</span>
          </a>
          <nav class="nav" aria-label="주요 메뉴">
            <a class="nav-link is-active" href="index.html">고객 관리</a>
            <a class="nav-link" href="page-2.html">고객 관리</a>
            <a class="nav-link" href="page-3.html">고객 관리</a>
          </nav>
          <div class="spacer"></div>
          <button class="login-btn" type="button">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 12c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5Zm0 2c-3.33 0-10 1.67-10 5v3h20v-3c0-3.33-6.67-5-10-5Z" />
            </svg>
            로그인하기
          </button>
        </div>
      </header>
      <main class="content">
        <h1 class="page-title">고객 관리</h1>
        <section aria-label="가입자 검색">
          <div class="search-row">
            <label class="search-field" for="memberSearch">
              <input
                id="memberSearch"
                class="search-input"
                type="search"
                placeholder="찾으시는 고객이 계신가요?"
                autocomplete="off"
              />
            </label>
            <button class="search-btn" type="button" id="searchBtn">검색</button>
          </div>
        </section>
        <section class="table-card" aria-label="가입자 리스트">
          <div class="table-scroll">
            <table class="member-table">
              <colgroup>
                <col style="width: 16%" />
                <col style="width: 16%" />
                <col style="width: 12%" />
                <col style="width: 10%" />
                <col style="width: 23%" />
                <col style="width: 23%" />
              </colgroup>
              <thead>
                <tr>
                  <th data-key="customer_name">고객명 <span class="caret"></span></th>
                  <th data-key="guardian_name">보호자명 <span class="caret"></span></th>
                  <th data-key="member_no">회원번호 <span class="caret"></span></th>
                  <th data-key="risk">위험도 <span class="caret"></span></th>
                  <th data-key="customer_phone">고객 연락처 <span class="caret"></span></th>
                  <th data-key="guardian_phone">보호자 연락처 <span class="caret"></span></th>
                </tr>
              </thead>
              <tbody id="memberList"></tbody>
            </table>
          </div>
          <div class="pagination" id="pagination" aria-label="가입자 페이지네이션"></div>
        </section>
      </main>
    </div>
    <script>
      const API_BASE = "http://127.0.0.1:8001";
      const PAGE_SIZE = 12;

      let members = [];
      let sortBy = "member_no";
      let sortOrder = "asc";
      let currentSearch = "";
      let currentPage = 1;

      const listEl = document.getElementById("memberList");
      const searchInput = document.getElementById("memberSearch");
      const searchBtn = document.getElementById("searchBtn");
      const scrollEl = document.querySelector(".table-scroll");
      const topbar = document.querySelector(".topbar");
      const paginationEl = document.getElementById("pagination");

      let lastWindowScroll = 0;
      let lastTableScroll = 0;

      async function fetchMembers() {
        const params = new URLSearchParams({
          search: currentSearch,
          sort_by: sortBy,
          order: sortOrder,
          limit: "200",
          offset: "0",
        });

        const res = await fetch(`${API_BASE}/members?${params.toString()}`);
        if (!res.ok) {
          console.error("members fetch failed", await res.text());
          return;
        }
        const data = await res.json();
        members = data.items || [];
        renderList(members);
        updateCarets();
      }

      function renderList(list, highlightNo = "") {
        const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        const startIndex = (currentPage - 1) * PAGE_SIZE;
        const pageItems = list.slice(startIndex, startIndex + PAGE_SIZE);

        listEl.innerHTML = pageItems
          .map((member) => {
            const highlightClass =
              highlightNo && member.memberNo === highlightNo
                ? "member-row is-highlight"
                : "member-row";
            return `
              <tr class="${highlightClass}" data-member="${member.memberNo}">
                <td>${member.customerName}</td>
                <td>${member.guardianName}</td>
                <td>${member.memberNo}</td>
                <td><span class="risk-pill">${member.risk}%</span></td>
                <td>${member.customerPhone}</td>
                <td>${member.guardianPhone}</td>
              </tr>
            `;
          })
          .join("");

        renderPagination(list.length);
      }

      function renderPagination(totalItems) {
        const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
        paginationEl.innerHTML = "";

        const fragment = document.createDocumentFragment();
        fragment.appendChild(
          buildPageButton("이전", currentPage - 1, currentPage === 1)
        );

        for (let page = 1; page <= totalPages; page += 1) {
          const button = buildPageButton(String(page), page, false, true);
          if (page === currentPage) button.classList.add("is-active");
          fragment.appendChild(button);
        }

        fragment.appendChild(
          buildPageButton("다음", currentPage + 1, currentPage === totalPages)
        );

        paginationEl.appendChild(fragment);
      }

      function buildPageButton(label, page, disabled, isNumber = false) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = isNumber ? "page-btn page-number" : "page-btn";
        button.textContent = label;
        button.disabled = disabled;
        button.addEventListener("click", () => {
          if (disabled) return;
          goToPage(page);
        });
        return button;
      }

      function goToPage(page) {
        currentPage = page;
        renderList(members);
        scrollEl.scrollTop = 0;
      }

      function updateCarets() {
        document.querySelectorAll(".member-table thead th[data-key]").forEach((th) => {
          const key = th.getAttribute("data-key");
          const caret = th.querySelector(".caret");
          if (!caret) return;

          if (key !== sortBy) {
            caret.textContent = "";
            return;
          }
          caret.textContent = sortOrder === "asc" ? "▲" : "▼";
        });
      }

      function onHeaderClick(th) {
        const key = th.getAttribute("data-key");
        if (!key) return;

        if (sortBy === key) {
          sortOrder = sortOrder === "asc" ? "desc" : "asc";
        } else {
          sortBy = key;
          sortOrder = "asc";
        }
        fetchMembers();
      }

      function applySearch() {
        const query = searchInput.value.trim();
        currentSearch = query;
        currentPage = 1;
        fetchMembers().then(() => {
          if (!query) return;
          const found = members.find((m) => m.memberNo === query);
          if (found) scrollEl.scrollTop = 0;
        });
      }

      function updateHeaderVisibility(current, last) {
        if (current > last && current > 12) {
          topbar.classList.add("is-hidden");
        } else if (current < last) {
          topbar.classList.remove("is-hidden");
        }
        return current;
      }

      window.addEventListener("scroll", () => {
        lastWindowScroll = updateHeaderVisibility(window.scrollY, lastWindowScroll);
      });

      scrollEl.addEventListener("scroll", () => {
        lastTableScroll = updateHeaderVisibility(scrollEl.scrollTop, lastTableScroll);
      });

      searchBtn.addEventListener("click", applySearch);
      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") applySearch();
      });

      document.querySelectorAll(".member-table thead th[data-key]").forEach((th) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => onHeaderClick(th));
      });

      fetchMembers();
    </script>
  </body>
</html>
